# üìö Bertie's Books - Full Stack Bookstore Web Application

A complete Node.js + Express + MySQL web application developed for the Web Development coursework.  
The system implements full CRUD book management, a secure user registration & login system, audit logging, environment variable protection, and deployment using Forever.

---

# ‚úÖ Table of Contents
1. [Project Overview](#project-overview)  
2. [Features](#features)  
3. [Technology Stack](#technology-stack)  
4. [Project Structure](#project-structure)  
5. [Installation & Setup](#installation--setup)  
6. [Database Setup](#database-setup)  
7. [User Authentication System](#user-authentication-system)  
8. [Audit Logging](#audit-logging)  
9. [Security with dotenv](#security-with-dotenv)  
10. [Default Login User (for marking)](#default-login-user-for-marking)  
11. [Deployment](#deployment)  
12. [Testing](#testing)  

---

# üéØ Project Overview
**Bertie‚Äôs Books** is an online bookstore where users can:

- Browse books  
- Add new books  
- Search books (exact + partial match)  
- View bargain books (< ¬£20)  
- Register an account  
- Log in securely using hashed passwords (bcrypt)  
- View login history in the Audit Log  
- Authenticate using a default user created for assessment  

This is the fully extended version of the coursework, implementing all tasks from A to D.

---

# ‚ú® Features

### üìò **Books**
- List all books  
- Add books  
- Search books (SQL LIKE)  
- Bargain books page  
- Fully styled EJS views  

### üë§ **User System**
- User registration with hashed passwords  
- Secure login  
- Prevents login with incorrect credentials  
- Login success/fail audit logging  

### üìä **Audit System**
- Stores every login attempt  
- Shows: username, status, timestamp  
- Accessible at  /users/audit

### üîê **Security Enhancements**
- MySQL credentials stored in `.env` file  
- Not included in GitHub (added to .gitignore)  
- Uses bcrypt with salt for password hashing  

### üß™ **Includes Default Assessor Account**
Created automatically using `insert_test_data.sql`:username: gold
password: smiths
---

# üõ†Ô∏è Technology Stack

| Component | Technology |
|----------|------------|
| Backend | Node.js (Express.js) |
| Frontend | EJS templates, CSS |
| Database | MySQL (mysql2 driver) |
| Security | bcrypt, dotenv |
| Deployment | Forever on Ubuntu VM |
| Version Control | Git + GitHub |

---

# üìÇ Project Structure
project/
‚îÇ‚îÄ‚îÄ index.js
‚îÇ‚îÄ‚îÄ db.js
‚îÇ‚îÄ‚îÄ package.json
‚îÇ‚îÄ‚îÄ .env
‚îÇ‚îÄ‚îÄ insert_test_data.sql
‚îÇ
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ main.js
‚îÇ   ‚îú‚îÄ‚îÄ books.js
‚îÇ   ‚îî‚îÄ‚îÄ users.js
‚îÇ
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îú‚îÄ‚îÄ index.ejs
‚îÇ   ‚îú‚îÄ‚îÄ about.ejs
‚îÇ   ‚îú‚îÄ‚îÄ login.ejs
‚îÇ   ‚îú‚îÄ‚îÄ register.ejs
‚îÇ   ‚îú‚îÄ‚îÄ audit.ejs
‚îÇ   ‚îú‚îÄ‚îÄ listusers.ejs
‚îÇ   ‚îú‚îÄ‚îÄ addbook.ejs
‚îÇ   ‚îú‚îÄ‚îÄ list.ejs
‚îÇ   ‚îú‚îÄ‚îÄ search.ejs
‚îÇ   ‚îî‚îÄ‚îÄ searchresult.ejs
‚îÇ
‚îî‚îÄ‚îÄ public/
‚îî‚îÄ‚îÄ main.css
---

# üöÄ Installation & Setup

## 1. Install dependencies
```bash
npm install
2. Create .env file
DB_HOST=localhost
DB_USER=berties_books_app
DB_PASSWORD=qwertyuiop
DB_NAME=berties_books

3. Run the SQL setup
mysql -u root -p < create_tables.sql
mysql -u root -p < insert_test_data.sql

4. Start the server
node index.js
Application runs at:http://localhost:8000

 Database Setup

‚úî Tables included:
	‚Ä¢	users
	‚Ä¢	books
	‚Ä¢	audit_log

‚úî Password hashing

All passwords are stored using bcrypt with saltRounds = 10.

‚∏ª

üîê User Authentication System

‚úî Registration
	‚Ä¢	Saves username, first name, last name, email, hashed password
	‚Ä¢	Rejects missing fields
	‚Ä¢	Shows confirmation message

‚úî Login
	‚Ä¢	Selects hashed password from DB
	‚Ä¢	Compares using:bcrypt.compare(password, hashedPassword)
    ‚Ä¢	On success: friendly welcome
	‚Ä¢	On failure: warning message


    üìä Audit Logging

Every login attempt is logged:
Column
Description
username
typed username
status
success / fail
timestamp
auto-filled

Security With dotenv

Why?

Database credentials must not be visible in GitHub.

How it works:
	1.	Installed dependency:npm install dotenv
    2.	Added to index.js:require('dotenv').config();
    3.	Moved credentials to .env
	4.	.env added to .gitignore



     Testing Checklist

üîπ Books
	‚Ä¢	Add a book
	‚Ä¢	View book list
	‚Ä¢	Search:
	‚Ä¢	exact
	‚Ä¢	partial
	‚Ä¢	Bargain books (< ¬£20)

üîπ Users
	‚Ä¢	Register new user
	‚Ä¢	Login with correct password
	‚Ä¢	Fail login intentionally

üîπ Audit
	‚Ä¢	Confirm login attempts appear in /users/audit

üîπ Default User
	‚Ä¢	Login using gold / smiths

üîê Access Control & Protected Routes (Task 5)

As part of Lab 8 ‚Äì Authorisation, I added access control using the redirectLogin middleware.
This middleware checks if a user session exists and redirects unauthenticated users to the login page.

//const redirectLogin = (req, res, next) => {
    if (!req.session.userId) {
        return res.redirect('/users/login');
    }
    next();
};//


Below is a summary of which routes are restricted and which remain publicly accessible.

‚∏ª

‚úî Protected Routes (Login Required)

üßë‚Äçüíº Users
	‚Ä¢	/users/list
	‚Ä¢	/users/audit
	‚Ä¢	/logout

These routes contain sensitive information such as user details or audit logs, so they are only accessible to authenticated users.

‚∏ª

üìö Books
	‚Ä¢	/books/list
	‚Ä¢	/books/addbook
	‚Ä¢	/books/bookadded

These pages allow management of the book database and therefore require the user to be logged in.

‚∏ª

üåê Public Routes (No Login Required)

üè† Main
	‚Ä¢	/ (Home)
	‚Ä¢	/about

üë§ Users
	‚Ä¢	/users/register
	‚Ä¢	/users/registered
	‚Ä¢	/users/login
	‚Ä¢	/users/loggedin

üìö Books
	‚Ä¢	/books/search
	‚Ä¢	/books/search-result
	‚Ä¢	/books/bargainbooks

These pages do not expose sensitive information and can safely be accessed without signing in.

‚∏ª

üîç Testing Notes

I tested the application both logged in and logged out:

When not logged in
	‚Ä¢	Attempting to visit any protected route correctly redirects to /users/login.
	‚Ä¢	Public pages load normally.

When logged in
	‚Ä¢	All protected pages are accessible.
	‚Ä¢	Session remains active until the user logs out.
	‚Ä¢	After logout, access to protected routes is removed again.

XSS Demonstration 

To demonstrate Cross-Site Scripting (XSS), I entered the following value into the First Name field on the registration page:
Henry <script>alert("Gotcha!")</script>

When I submitted the form, the following popup appeared in my browser:

Gotcha!

‚ö† Why did this happen?

The vulnerability occurs because:
	1.	User input is not sanitised or escaped.
The <script> tag entered by the user is stored and processed without any filtering.
	2.	The unsanitised value is printed directly into the HTML response, for example:
	let resultMessage = 'Hello ' + req.body.first + ' you are registered!';
	3.	When the browser receives this HTML, it interprets the <script> tag as actual JavaScript:
	Hello Henry <script>alert("Gotcha!")</script>
	4.	The browser executes the script, causing the popup.
This proves the application is vulnerable to XSS attacks.

This vulnerability will later be fixed using proper sanitisation (e.g., express-validator, escape(), or DOM encoding).

!!!!VALIDATION!!!!

‚úî Server-Side Validation 

I added validation checks using the express-validator module.
The following fields are validated on the registration form:
	‚Ä¢	Email ‚Üí must be a valid email format
	‚Ä¢	Username ‚Üí must be between 5‚Äì20 characters
	‚Ä¢	Password ‚Üí minimum 8 characters to ensure stronger security
	‚Ä¢	First Name ‚Üí cannot be empty
	‚Ä¢	Last Name ‚Üí cannot be empty

If any validation fails, the registration page reloads and displays error messages.
This prevents invalid or incomplete form submissions.

I chose these validations because:
	‚Ä¢	Email format is frequently mistyped
	‚Ä¢	Username length prevents extremely short or long values
	‚Ä¢	Password length increases security
	‚Ä¢	First/Last name empty submissions cause poor data quality


!!!!SANITISATION!!!!

‚úî Input Sanitisation & XSS Protection 

To protect against Cross-Site Scripting (XSS) attacks, I installed and enabled the express-sanitizer module:
const expressSanitizer = require('express-sanitizer');
app.use(expressSanitizer());

I then sanitised all user inputs on the registration form:

req.body.first = req.sanitize(req.body.first);
req.body.last = req.sanitize(req.body.last);
req.body.username = req.sanitize(req.body.username);
req.body.email = req.sanitize(req.body.email);
req.body.password = req.sanitize(req.body.password);

This removes dangerous code such as:
<script>alert("Gotcha!")</script>
Before sanitisation, the above payload caused a JavaScript popup (demonstrating XSS).
After sanitisation, the script tags are stripped and treated as harmless text.

I also sanitised additional form fields in the application where user input is saved:
	‚Ä¢	Registration page (all text fields)
	‚Ä¢	Login page (username)
	‚Ä¢	Book pages (book name, book price)

Fields that do NOT accept user input (e.g., dropdowns, static values) were not sanitised because they cannot contain injected code.


Bertie‚Äôs Books ‚Äì API & Weather Features

This project extends the Bertie‚Äôs Books application by adding:
	‚Ä¢	A custom REST API that provides book data
	‚Ä¢	Search, price filtering, and sorting features (Part C extensions)
	‚Ä¢	A weather forecast page using the OpenWeatherMap API

üìå Weather Feature (Lab 9A)

Route:/weather

Description:

Displays current weather information for any city using the OpenWeatherMap API.

Features:
	‚Ä¢	User can enter a city name in a form
	‚Ä¢	Temperature, humidity, wind speed, ‚Äúfeels like‚Äù value displayed
	‚Ä¢	Weather icon shown visually
	‚Ä¢	Friendly error handling if city is not found

Example URL: http://localhost:8000/weather?city=London

üìå Books API

All API routes begin with:/api
### 1. Get all books
GET /api/books


 2. Search books
 Search by name : GET /api/books?search=keyword
 Example : /api/books?search=world


 3. Filter by price range
 GET /api/books?minprice=X&maxprice=Y
 /api/books?minprice=5&maxprice=15


 4. Sorting books

 By name : /api/books?sort=name
 By Price : /api/books?sort=price
 /api/books?minprice=0&maxprice=50&sort=price



 ‚úîÔ∏è Error Handling

The API returns meaningful messages if:
	‚Ä¢	A city is not found (weather endpoint)
	‚Ä¢	No books match search or filters
